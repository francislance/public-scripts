# Helm Release History Tools

This repo contains two helper scripts to **inspect** and **trim** Helm release history across all namespaces in a Kubernetes cluster.

- `check-helm-releases.sh` – scans all namespaces, collects `helm history` per release, and writes 2 reports.
- `trim-helm-releases.sh` – reads the summary report and deletes old/failed Helm history secrets.

---

## 1. Prerequisites

You need:

- `bash`
- `kubectl` (configured to talk to your cluster)
- `helm`
- `jq` (only required for `trim-helm-releases.sh`)

Run everything from a machine that can reach the cluster (e.g., your admin workstation or a bastion).

---

## 2. Script: `check-helm-releases.sh`

Scan all namespaces and list Helm releases with more history than allowed.

### What it does

- Iterates over all namespaces: `kubectl get ns`
- For each namespace:
    - Lists Helm releases: `helm list -n <ns> -q`
    - Gets history: `helm history <release> -n <ns>`
    - Counts revisions
- Produces two files in the current directory:
    - `helm-releases-summary.txt`
        - Only releases with **more than N revisions**
        - Simple table: `NAMESPACE | RELEASE | REVISIONS`
    - `helm-releases-details.txt`
        - Full `helm history` output for every release

### History limit

By default, only releases with more than **3** revisions are considered “over limit”.

You can control this via:

- Environment variable: `HISTORY_LIMIT`
- CLI option: `--history-limit=N`

Precedence: **CLI > env > default**

### Usage

```bash
# basic run (default limit 3)
./check-helm-releases.sh

# use env var
HISTORY_LIMIT=5 ./check-helm-releases.sh

# use CLI option
./check-helm-releases.sh --history-limit=5

# show help
./check-helm-releases.sh --help
```

## 3. Script: `rim-helm-releases.sh`

Trim Helm history by deleting Helm release secrets based on the summary file.

### What it does

Consumes the summary produced by check-helm-releases.sh and:

- Default mode (history limit trim)

  Keeps the latest N revisions per release (where N is the History limit recorded in the summary file) and deletes the older ones by removing:
  ``` sh.helm.release.v1.<release-name>.v<revision> ```

- Failed-only mode (--failed-only)

  Ignores history limit. For each release:
  - Looks up helm history -o json
  - Finds revisions where status == "failed"
  - Deletes only those failed revision secrets. (No oldest/limit-based deletion in this mode.)

By default, it shows you which secrets will be deleted per release and asks for confirmation.

### Options

- --file=FILE 
  - Summary file generated by check-helm-releases.sh. 
  - Default: helm-releases-summary.txt
- --confirm=yes|no 
  - yes (default): ask per release before deleting 
  - no: delete without per-release confirmation (non-interactive)
- --failed-only 
  - Only delete revisions with status failed. Ignores history limit.

### Safety checks

- Verifies the input file:
  - Must contain the marker: `Report generated through script - check-helm.sh`
- Must contain a line like: `History limit: N`

If any of those are missing or invalid, it aborts.

### Usage examples

```
# (1) First, generate the summary
./check-helm-releases.sh --history-limit=3

# (2) Then, trim using the generated summary (interactive)
./trim-helm-releases.sh

# Non-interactive, history-limit based trimming
./trim-helm-releases.sh --confirm=no

# Use an explicit summary file
./trim-helm-releases.sh --file=my-summary.txt

# FAILED ONLY mode (delete only failed revisions, still asks per release)
./trim-helm-releases.sh --failed-only

# FAILED ONLY + non-interactive
./trim-helm-releases.sh --failed-only --confirm=no
```

You’ll see output like:

```
Processing release 'my-app' in namespace 'prod'
Reported revisions (from check-helm.sh): 7
History limit (to keep): 3
Actual current revision count: 7
Revisions to keep (latest 3):
  5 6 7
Revisions to delete (oldest 4):
  1 2 3 4
Secrets to be deleted for release 'my-app' in namespace 'prod':
- sh.helm.release.v1.my-app.v1, namespace prod
...
Proceed to delete these secrets? [yes/no]:
```

## 4. Recommended Workflow

### Review history first

```
./check-helm-releases.sh --history-limit=3
less helm-releases-summary.txt
```
### Trim carefully
Start interactively so you can see what will be deleted:
```
./trim-helm-releases.sh
```
### Automate (optional)
Once you’re comfortable:
```
# e.g. in a cronjob or maintenance script
./check-helm-releases.sh --history-limit=3
./trim-helm-releases.sh --confirm=no
```

## 5. Notes

- These scripts only delete Helm history secrets, not live releases or workloads. 
- Deleting history reduces etcd size and Helm clutter, but you will lose older rollback points. 
- Always test in a non-production cluster first.